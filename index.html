<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Bee Token Admin Panel</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <!-- Firebase SDKs -->
    <script src="https://www.gstatic.com/firebasejs/9.6.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.0/firebase-database-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.0/firebase-auth-compat.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }
        
        :root {
            --primary-yellow: #FFD700;
            --secondary-yellow: #FFEE58;
            --dark-yellow: #F9A825;
            --black: #1A1A1A;
            --white: #FFFFFF;
            --gray: #F5F5F5;
            --green: #4CAF50;
            --red: #F44336;
            --blue: #2196F3;
            --admin-bg: #0F172A;
            --admin-text: #E2E8F0;
            --admin-card: #1E293B;
            --admin-border: #334155;
        }
        
        body {
            background-color: var(--admin-bg);
            color: var(--admin-text);
            min-height: 100vh;
        }
        
        /* Login Page */
        .login-container {
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 100vh;
            background: linear-gradient(135deg, var(--admin-bg) 0%, #1E3A8A 100%);
        }
        
        .login-box {
            background-color: var(--admin-card);
            padding: 40px;
            border-radius: 15px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.3);
            width: 100%;
            max-width: 400px;
            border: 1px solid var(--admin-border);
        }
        
        .login-logo {
            text-align: center;
            margin-bottom: 30px;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 15px;
        }
        
        .login-logo i {
            font-size: 36px;
            color: var(--primary-yellow);
        }
        
        .login-logo h2 {
            font-size: 28px;
            color: var(--primary-yellow);
        }
        
        .login-form input {
            width: 100%;
            padding: 12px 15px;
            margin-bottom: 20px;
            border: 1px solid var(--admin-border);
            border-radius: 8px;
            background-color: rgba(255, 255, 255, 0.1);
            color: var(--admin-text);
            font-size: 16px;
        }
        
        .login-form input:focus {
            outline: none;
            border-color: var(--primary-yellow);
            box-shadow: 0 0 0 2px rgba(255, 215, 0, 0.2);
        }
        
        .login-button {
            width: 100%;
            padding: 14px;
            background: linear-gradient(to right, var(--primary-yellow), var(--dark-yellow));
            color: var(--black);
            border: none;
            border-radius: 8px;
            font-size: 16px;
            font-weight: bold;
            cursor: pointer;
            transition: transform 0.2s;
        }
        
        .login-button:hover {
            transform: translateY(-2px);
        }
        
        .login-button:disabled {
            opacity: 0.6;
            cursor: not-allowed;
        }
        
        .error-message {
            color: var(--red);
            margin-top: 10px;
            text-align: center;
            font-size: 14px;
            display: none;
        }
        
        /* Admin Dashboard */
        .admin-container {
            display: none;
            min-height: 100vh;
        }
        
        .sidebar {
            width: 250px;
            background-color: var(--admin-card);
            position: fixed;
            height: 100vh;
            overflow-y: auto;
            border-right: 1px solid var(--admin-border);
        }
        
        .sidebar-header {
            padding: 25px;
            text-align: center;
            border-bottom: 1px solid var(--admin-border);
        }
        
        .sidebar-header h2 {
            color: var(--primary-yellow);
            font-size: 24px;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 10px;
        }
        
        .sidebar-menu {
            padding: 20px 0;
        }
        
        .menu-item {
            padding: 15px 25px;
            display: flex;
            align-items: center;
            gap: 12px;
            cursor: pointer;
            transition: all 0.3s;
            border-left: 3px solid transparent;
        }
        
        .menu-item:hover {
            background-color: rgba(255, 215, 0, 0.1);
            border-left-color: var(--primary-yellow);
        }
        
        .menu-item.active {
            background-color: rgba(255, 215, 0, 0.15);
            border-left-color: var(--primary-yellow);
            color: var(--primary-yellow);
        }
        
        .menu-item i {
            width: 20px;
            text-align: center;
        }
        
        .main-content {
            margin-left: 250px;
            padding: 20px;
            width: calc(100% - 250px);
        }
        
        .top-bar {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 20px;
            background-color: var(--admin-card);
            border-radius: 10px;
            margin-bottom: 30px;
            border: 1px solid var(--admin-border);
        }
        
        .user-info {
            display: flex;
            align-items: center;
            gap: 15px;
        }
        
        .logout-btn {
            padding: 8px 20px;
            background-color: var(--red);
            color: white;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-weight: bold;
        }
        
        .logout-btn:hover {
            background-color: #d32f2f;
        }
        
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }
        
        .stat-card {
            background-color: var(--admin-card);
            padding: 25px;
            border-radius: 12px;
            border: 1px solid var(--admin-border);
            display: flex;
            justify-content: space-between;
            align-items: center;
            transition: transform 0.3s;
        }
        
        .stat-card:hover {
            transform: translateY(-5px);
            border-color: var(--primary-yellow);
        }
        
        .stat-card .label {
            font-size: 14px;
            color: #94A3B8;
            margin-bottom: 5px;
        }
        
        .stat-card .value {
            font-size: 32px;
            font-weight: bold;
            color: var(--primary-yellow);
        }
        
        .stat-card i {
            font-size: 48px;
            color: rgba(255, 215, 0, 0.3);
        }
        
        .content-section {
            display: none;
            background-color: var(--admin-card);
            padding: 30px;
            border-radius: 12px;
            border: 1px solid var(--admin-border);
            margin-bottom: 30px;
        }
        
        .content-section.active {
            display: block;
        }
        
        .section-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 25px;
        }
        
        .section-header h3 {
            font-size: 22px;
            color: var(--primary-yellow);
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        .search-box {
            display: flex;
            gap: 10px;
            margin-bottom: 20px;
        }
        
        .search-box input {
            flex: 1;
            padding: 12px 15px;
            border: 1px solid var(--admin-border);
            border-radius: 8px;
            background-color: rgba(255, 255, 255, 0.05);
            color: var(--admin-text);
        }
        
        .search-box button {
            padding: 12px 25px;
            background-color: var(--blue);
            color: white;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-weight: bold;
        }
        
        /* User Table */
        .user-table-container {
            overflow-x: auto;
            border-radius: 8px;
            border: 1px solid var(--admin-border);
        }
        
        .user-table {
            width: 100%;
            border-collapse: collapse;
            min-width: 800px;
        }
        
        .user-table th {
            background-color: #2D3748;
            padding: 15px;
            text-align: left;
            color: var(--primary-yellow);
            font-weight: 600;
            border-bottom: 2px solid var(--admin-border);
        }
        
        .user-table td {
            padding: 15px;
            border-bottom: 1px solid var(--admin-border);
        }
        
        .user-table tr:hover {
            background-color: rgba(255, 215, 0, 0.05);
        }
        
        .user-table tr:last-child td {
            border-bottom: none;
        }
        
        /* Action Buttons */
        .action-btn {
            padding: 6px 12px;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            font-size: 14px;
            font-weight: bold;
            margin-right: 5px;
        }
        
        .edit-btn {
            background-color: var(--blue);
            color: white;
        }
        
        .delete-btn {
            background-color: var(--red);
            color: white;
        }
        
        .view-btn {
            background-color: var(--green);
            color: white;
        }
        
        /* Settings Form */
        .settings-form {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 25px;
        }
        
        .form-group {
            margin-bottom: 20px;
        }
        
        .form-group label {
            display: block;
            margin-bottom: 8px;
            color: var(--primary-yellow);
            font-weight: 600;
        }
        
        .form-group input,
        .form-group select,
        .form-group textarea {
            width: 100%;
            padding: 12px 15px;
            border: 1px solid var(--admin-border);
            border-radius: 8px;
            background-color: rgba(255, 255, 255, 0.05);
            color: var(--admin-text);
            font-size: 16px;
        }
        
        .form-group textarea {
            min-height: 100px;
            resize: vertical;
        }
        
        .save-btn {
            padding: 14px 30px;
            background: linear-gradient(to right, var(--green), #2E7D32);
            color: white;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-size: 16px;
            font-weight: bold;
            grid-column: 1 / -1;
            justify-self: start;
        }
        
        .save-btn:hover {
            background: linear-gradient(to right, #45a049, #1B5E20);
        }
        
        /* Modal */
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.7);
            z-index: 1000;
            justify-content: center;
            align-items: center;
        }
        
        .modal-content {
            background-color: var(--admin-card);
            padding: 30px;
            border-radius: 12px;
            width: 90%;
            max-width: 500px;
            border: 1px solid var(--admin-border);
        }
        
        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }
        
        .modal-title {
            font-size: 20px;
            color: var(--primary-yellow);
        }
        
        .close-modal {
            background: none;
            border: none;
            color: var(--admin-text);
            font-size: 24px;
            cursor: pointer;
        }
        
        /* Loading Spinner */
        .loading-spinner {
            display: inline-block;
            width: 20px;
            height: 20px;
            border: 3px solid rgba(255, 255, 255, 0.3);
            border-radius: 50%;
            border-top-color: var(--primary-yellow);
            animation: spin 1s ease-in-out infinite;
        }
        
        @keyframes spin {
            to { transform: rotate(360deg); }
        }
        
        /* Responsive */
        @media (max-width: 768px) {
            .sidebar {
                width: 70px;
            }
            
            .sidebar-header h2 span,
            .menu-item span {
                display: none;
            }
            
            .main-content {
                margin-left: 70px;
                width: calc(100% - 70px);
            }
            
            .stats-grid {
                grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            }
        }
        
        @media (max-width: 480px) {
            .stats-grid {
                grid-template-columns: 1fr;
            }
            
            .login-box {
                padding: 20px;
                margin: 20px;
            }
        }
    </style>
</head>
<body>
    <!-- Login Page -->
    <div class="login-container" id="login-page">
        <div class="login-box">
            <div class="login-logo">
                <i class="fas fa-bee"></i>
                <h2>Bee Token Admin</h2>
            </div>
            <form class="login-form" id="login-form">
                <input type="email" id="admin-email" placeholder="Admin Email" required>
                <input type="password" id="admin-password" placeholder="Password" required>
                <button type="submit" class="login-button" id="login-btn">Login to Dashboard</button>
                <div class="error-message" id="login-error"></div>
            </form>
        </div>
    </div>

    <!-- Admin Dashboard -->
    <div class="admin-container" id="admin-dashboard">
        <!-- Sidebar -->
        <div class="sidebar">
            <div class="sidebar-header">
                <h2><i class="fas fa-bee"></i> <span>Bee Admin</span></h2>
            </div>
            <div class="sidebar-menu">
                <div class="menu-item active" data-section="dashboard">
                    <i class="fas fa-tachometer-alt"></i>
                    <span>Dashboard</span>
                </div>
                <div class="menu-item" data-section="users">
                    <i class="fas fa-users"></i>
                    <span>User Management</span>
                </div>
                <div class="menu-item" data-section="settings">
                    <i class="fas fa-cog"></i>
                    <span>System Settings</span>
                </div>
                <div class="menu-item" data-section="withdrawals">
                    <i class="fas fa-wallet"></i>
                    <span>Withdrawals</span>
                </div>
                <div class="menu-item" data-section="referrals">
                    <i class="fas fa-user-friends"></i>
                    <span>Referral System</span>
                </div>
                <div class="menu-item" data-section="logs">
                    <i class="fas fa-history"></i>
                    <span>Activity Logs</span>
                </div>
            </div>
        </div>

        <!-- Main Content -->
        <div class="main-content">
            <!-- Top Bar -->
            <div class="top-bar">
                <div>
                    <h1>Admin Dashboard</h1>
                    <p id="current-date">Loading...</p>
                </div>
                <div class="user-info">
                    <span id="admin-email-display">admin@bee.com</span>
                    <button class="logout-btn" onclick="logoutAdmin()">
                        <i class="fas fa-sign-out-alt"></i> Logout
                    </button>
                </div>
            </div>

            <!-- Dashboard Statistics -->
            <div class="stats-grid">
                <div class="stat-card">
                    <div>
                        <div class="label">Total Users</div>
                        <div class="value" id="stat-total-users">0</div>
                    </div>
                    <i class="fas fa-users"></i>
                </div>
                <div class="stat-card">
                    <div>
                        <div class="label">Total Tokens</div>
                        <div class="value" id="stat-total-tokens">0</div>
                    </div>
                    <i class="fas fa-coins"></i>
                </div>
                <div class="stat-card">
                    <div>
                        <div class="label">Total USDT</div>
                        <div class="value" id="stat-total-usdt">$0.00</div>
                    </div>
                    <i class="fas fa-dollar-sign"></i>
                </div>
                <div class="stat-card">
                    <div>
                        <div class="label">Total Referrals</div>
                        <div class="value" id="stat-total-referrals">0</div>
                    </div>
                    <i class="fas fa-user-friends"></i>
                </div>
                <div class="stat-card">
                    <div>
                        <div class="label">Pending Withdrawals</div>
                        <div class="value" id="stat-pending-withdrawals">0</div>
                    </div>
                    <i class="fas fa-wallet"></i>
                </div>
                <div class="stat-card">
                    <div>
                        <div class="label">Active Today</div>
                        <div class="value" id="stat-active-today">0</div>
                    </div>
                    <i class="fas fa-chart-line"></i>
                </div>
            </div>

            <!-- Dashboard Section -->
            <div class="content-section active" id="dashboard-section">
                <div class="section-header">
                    <h3><i class="fas fa-tachometer-alt"></i> Dashboard Overview</h3>
                </div>
                <div style="display: grid; grid-template-columns: 2fr 1fr; gap: 20px;">
                    <div style="background-color: rgba(255,255,255,0.05); padding: 20px; border-radius: 8px;">
                        <h4 style="margin-bottom: 15px; color: var(--primary-yellow);">Recent Activity</h4>
                        <div id="recent-activity">
                            <p>Loading recent activity...</p>
                        </div>
                    </div>
                    <div style="background-color: rgba(255,255,255,0.05); padding: 20px; border-radius: 8px;">
                        <h4 style="margin-bottom: 15px; color: var(--primary-yellow);">Quick Actions</h4>
                        <div style="display: flex; flex-direction: column; gap: 10px;">
                            <button class="action-btn view-btn" onclick="showSection('users')">
                                <i class="fas fa-users"></i> View All Users
                            </button>
                            <button class="action-btn edit-btn" onclick="showSection('withdrawals')">
                                <i class="fas fa-wallet"></i> Process Withdrawals
                            </button>
                            <button class="action-btn edit-btn" onclick="updateAllUserStats()">
                                <i class="fas fa-sync"></i> Refresh Statistics
                            </button>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Users Section -->
            <div class="content-section" id="users-section">
                <div class="section-header">
                    <h3><i class="fas fa-users"></i> User Management</h3>
                    <div class="search-box">
                        <input type="text" id="user-search" placeholder="Search by User ID, Email or Telegram ID...">
                        <button onclick="searchUsers()">Search</button>
                    </div>
                </div>
                <div class="user-table-container">
                    <table class="user-table" id="users-table">
                        <thead>
                            <tr>
                                <th>User ID</th>
                                <th>Name</th>
                                <th>Tokens</th>
                                <th>USDT</th>
                                <th>Referrals</th>
                                <th>Status</th>
                                <th>Joined Date</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody id="users-table-body">
                            <tr>
                                <td colspan="8" style="text-align: center; padding: 30px;">Loading users...</td>
                            </tr>
                        </tbody>
                    </table>
                </div>
                <div style="display: flex; justify-content: space-between; margin-top: 20px;">
                    <div id="pagination-info">Showing 0 of 0 users</div>
                    <div>
                        <button onclick="prevPage()" style="margin-right: 10px;">Previous</button>
                        <button onclick="nextPage()">Next</button>
                    </div>
                </div>
            </div>

            <!-- Settings Section -->
            <div class="content-section" id="settings-section">
                <div class="section-header">
                    <h3><i class="fas fa-cog"></i> System Settings</h3>
                </div>
                <form class="settings-form" id="system-settings">
                    <div class="form-group">
                        <label>Token Conversion Rate (1 BEE = ? USDT)</label>
                        <input type="number" id="token-rate" step="0.00001" min="0">
                    </div>
                    <div class="form-group">
                        <label>Daily Airdrop Reward (Tokens)</label>
                        <input type="number" id="daily-airdrop" min="0">
                    </div>
                    <div class="form-group">
                        <label>Ad Reward Amount (Tokens per ad)</label>
                        <input type="number" id="ad-reward" min="0">
                    </div>
                    <div class="form-group">
                        <label>Task Reward Amount (Tokens per task)</label>
                        <input type="number" id="task-reward" min="0">
                    </div>
                    <div class="form-group">
                        <label>Referral Reward (Tokens per referral)</label>
                        <input type="number" id="referral-reward" min="0">
                    </div>
                    <div class="form-group">
                        <label>Minimum Referrals for Withdrawal</label>
                        <input type="number" id="min-referrals" min="0">
                    </div>
                    <div class="form-group">
                        <label>Minimum Withdrawal Amount (USDT)</label>
                        <input type="number" id="min-withdrawal" step="0.01" min="0">
                    </div>
                    <div class="form-group">
                        <label>Referral Link Base URL</label>
                        <input type="text" id="referral-link-base" placeholder="https://t.me/your_bot_or_app?start=">
                    </div>
                    <div class="form-group">
                        <label>System Maintenance Message</label>
                        <textarea id="maintenance-message" placeholder="System is running normally..."></textarea>
                    </div>
                    <button type="button" class="save-btn" onclick="saveSystemSettings()">
                        <i class="fas fa-save"></i> Save All Settings
                    </button>
                </form>
            </div>

            <!-- Withdrawals Section -->
            <div class="content-section" id="withdrawals-section">
                <div class="section-header">
                    <h3><i class="fas fa-wallet"></i> Withdrawal Requests</h3>
                </div>
                <table class="user-table" id="withdrawals-table">
                    <thead>
                        <tr>
                            <th>ID</th>
                            <th>User ID</th>
                            <th>Amount (USDT)</th>
                            <th>Wallet Address</th>
                            <th>Status</th>
                            <th>Request Date</th>
                            <th>Actions</th>
                        </tr>
                    </thead>
                    <tbody id="withdrawals-table-body">
                        <tr>
                            <td colspan="7" style="text-align: center; padding: 30px;">Loading withdrawals...</td>
                        </tr>
                    </tbody>
                </table>
            </div>

            <!-- Referrals Section -->
            <div class="content-section" id="referrals-section">
                <div class="section-header">
                    <h3><i class="fas fa-user-friends"></i> Referral System</h3>
                </div>
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px; margin-bottom: 20px;">
                    <div style="background-color: rgba(255,255,255,0.05); padding: 20px; border-radius: 8px;">
                        <h4 style="color: var(--primary-yellow); margin-bottom: 10px;">Top Referrers</h4>
                        <div id="top-referrers">Loading...</div>
                    </div>
                    <div style="background-color: rgba(255,255,255,0.05); padding: 20px; border-radius: 8px;">
                        <h4 style="color: var(--primary-yellow); margin-bottom: 10px;">Referral Statistics</h4>
                        <div id="referral-stats">Loading...</div>
                    </div>
                </div>
                <table class="user-table">
                    <thead>
                        <tr>
                            <th>Referrer</th>
                            <th>Referred User</th>
                            <th>Reward Given</th>
                            <th>Date</th>
                        </tr>
                    </thead>
                    <tbody id="referrals-table-body">
                        <tr>
                            <td colspan="4" style="text-align: center; padding: 30px;">Loading referral data...</td>
                        </tr>
                    </tbody>
                </table>
            </div>

            <!-- Logs Section -->
            <div class="content-section" id="logs-section">
                <div class="section-header">
                    <h3><i class="fas fa-history"></i> Activity Logs</h3>
                    <div class="search-box">
                        <input type="text" id="log-search" placeholder="Search logs...">
                        <button onclick="searchLogs()">Search</button>
                    </div>
                </div>
                <div style="margin-bottom: 20px;">
                    <button onclick="filterLogs('all')" style="margin-right: 10px;">All</button>
                    <button onclick="filterLogs('airdrop')" style="margin-right: 10px;">Airdrops</button>
                    <button onclick="filterLogs('ad')" style="margin-right: 10px;">Ads</button>
                    <button onclick="filterLogs('withdrawal')" style="margin-right: 10px;">Withdrawals</button>
                    <button onclick="filterLogs('referral')">Referrals</button>
                </div>
                <div id="activity-logs">
                    <p>Loading activity logs...</p>
                </div>
            </div>
        </div>
    </div>

    <!-- User Edit Modal -->
    <div class="modal" id="user-edit-modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 class="modal-title">Edit User</h3>
                <button class="close-modal" onclick="closeModal('user-edit-modal')">&times;</button>
            </div>
            <form id="edit-user-form">
                <div class="form-group">
                    <label>User ID</label>
                    <input type="text" id="edit-user-id" readonly>
                </div>
                <div class="form-group">
                    <label>Name</label>
                    <input type="text" id="edit-user-name">
                </div>
                <div class="form-group">
                    <label>Tokens Balance</label>
                    <input type="number" id="edit-user-tokens" min="0">
                </div>
                <div class="form-group">
                    <label>USDT Balance</label>
                    <input type="number" id="edit-user-usdt" step="0.0001" min="0">
                </div>
                <div class="form-group">
                    <label>Referral Count</label>
                    <input type="number" id="edit-user-referrals" min="0">
                </div>
                <div class="form-group">
                    <label>Account Status</label>
                    <select id="edit-user-status">
                        <option value="active">Active</option>
                        <option value="suspended">Suspended</option>
                        <option value="banned">Banned</option>
                    </select>
                </div>
                <button type="button" class="save-btn" onclick="saveUserEdits()">Save Changes</button>
            </form>
        </div>
    </div>

    <script>
        // Firebase Configuration
        const firebaseConfig = {
            apiKey: "AIzaSyASMBf-fL9tJOj2sgKdpVK77TYRMga1bag",
            authDomain: "money-host-56ee9.firebaseapp.com",
            databaseURL: "https://money-host-56ee9-default-rtdb.firebaseio.com",
            projectId: "money-host-56ee9",
            storageBucket: "money-host-56ee9.firebasestorage.app",
            messagingSenderId: "701262930342",
            appId: "1:701262930342:web:a8c49ea25b730332ff2f67"
        };

        // Initialize Firebase
        const app = firebase.initializeApp(firebaseConfig);
        const database = firebase.database();
        const auth = firebase.auth();

        // Admin credentials
        const ADMIN_EMAIL = "admin@beetoken.com";
        const ADMIN_PASSWORD = "Admin@123";

        // Global Variables
        let currentUser = null;
        let usersData = [];
        let filteredUsers = [];
        let currentPage = 1;
        const usersPerPage = 20;
        let systemSettings = {};

        // Initialize Admin Panel
        document.addEventListener('DOMContentLoaded', function() {
            const savedAdmin = localStorage.getItem('bee_admin_logged_in');
            if (savedAdmin === 'true') {
                showAdminDashboard();
                loadDashboardData();
            }
            
            updateCurrentDate();
            setupMenuHandlers();
            setupLoginForm();
        });

        // Update current date
        function updateCurrentDate() {
            const now = new Date();
            const options = { 
                weekday: 'long', 
                year: 'numeric', 
                month: 'long', 
                day: 'numeric' 
            };
            document.getElementById('current-date').textContent = now.toLocaleDateString('en-US', options);
        }

        // Setup menu handlers
        function setupMenuHandlers() {
            document.querySelectorAll('.menu-item').forEach(item => {
                item.addEventListener('click', function() {
                    const section = this.getAttribute('data-section');
                    
                    document.querySelectorAll('.menu-item').forEach(i => i.classList.remove('active'));
                    this.classList.add('active');
                    
                    showSection(section);
                });
            });
        }

        // Show section
        function showSection(section) {
            document.querySelectorAll('.content-section').forEach(sec => {
                sec.classList.remove('active');
            });
            
            document.getElementById(section + '-section').classList.add('active');
            
            switch(section) {
                case 'users':
                    loadUsers();
                    break;
                case 'withdrawals':
                    loadWithdrawals();
                    break;
                case 'referrals':
                    loadReferrals();
                    break;
                case 'logs':
                    loadActivityLogs();
                    break;
                case 'settings':
                    loadSystemSettings();
                    break;
            }
        }

        // Setup login form
        function setupLoginForm() {
            document.getElementById('login-form').addEventListener('submit', function(e) {
                e.preventDefault();
                loginAdmin();
            });
        }

        // Admin login
        function loginAdmin() {
            const email = document.getElementById('admin-email').value;
            const password = document.getElementById('admin-password').value;
            const loginBtn = document.getElementById('login-btn');
            const errorDiv = document.getElementById('login-error');
            
            if (email === ADMIN_EMAIL && password === ADMIN_PASSWORD) {
                loginBtn.disabled = true;
                loginBtn.innerHTML = '<span class="loading-spinner"></span> Logging in...';
                
                setTimeout(() => {
                    localStorage.setItem('bee_admin_logged_in', 'true');
                    
                    showAdminDashboard();
                    loadDashboardData();
                    
                    loginBtn.disabled = false;
                    loginBtn.textContent = 'Login to Dashboard';
                    errorDiv.style.display = 'none';
                }, 1500);
            } else {
                errorDiv.textContent = 'Invalid email or password';
                errorDiv.style.display = 'block';
            }
        }

        // Show admin dashboard
        function showAdminDashboard() {
            document.getElementById('login-page').style.display = 'none';
            document.getElementById('admin-dashboard').style.display = 'flex';
            document.getElementById('admin-email-display').textContent = ADMIN_EMAIL;
        }

        // Logout admin
        function logoutAdmin() {
            if (confirm('Are you sure you want to logout?')) {
                localStorage.removeItem('bee_admin_logged_in');
                document.getElementById('admin-dashboard').style.display = 'none';
                document.getElementById('login-page').style.display = 'flex';
                
                document.getElementById('admin-email').value = '';
                document.getElementById('admin-password').value = '';
            }
        }

        // Load dashboard data
        async function loadDashboardData() {
            try {
                // Load users data - FIXED PATH
                const usersRef = database.ref('users');
                usersRef.on('value', (snapshot) => {
                    if (snapshot.exists()) {
                        usersData = [];
                        let totalTokens = 0;
                        let totalReferrals = 0;
                        let activeToday = 0;
                        const today = new Date().toISOString().split('T')[0];
                        
                        snapshot.forEach((childSnapshot) => {
                            const user = childSnapshot.val();
                            user.id = childSnapshot.key;
                            usersData.push(user);
                            
                            // Calculate totals - FIXED DATA STRUCTURE
                            if (user.appState) {
                                totalTokens += user.appState.tokens || 0;
                            } else {
                                // Check alternative paths
                                if (user.tokens) totalTokens += user.tokens;
                            }
                            
                            totalReferrals += user.referrals || 0;
                            
                            if (user.lastActive && user.lastActive.includes(today)) {
                                activeToday++;
                            }
                        });
                        
                        // Update dashboard stats
                        document.getElementById('stat-total-users').textContent = usersData.length;
                        document.getElementById('stat-total-tokens').textContent = totalTokens.toLocaleString();
                        document.getElementById('stat-total-referrals').textContent = totalReferrals;
                        document.getElementById('stat-active-today').textContent = activeToday;
                        
                        // Calculate USDT value
                        const rate = systemSettings.tokenRate || 0.001;
                        const totalUSDT = totalTokens * rate;
                        document.getElementById('stat-total-usdt').textContent = `$${totalUSDT.toFixed(2)}`;
                        
                        // Load users table if on users page
                        if (document.getElementById('users-section').classList.contains('active')) {
                            loadUsers();
                        }
                    }
                });
                
                // Load withdrawal requests - FIXED PATH
                const withdrawalsRef = database.ref('withdrawals');
                withdrawalsRef.on('value', (snapshot) => {
                    let pendingCount = 0;
                    if (snapshot.exists()) {
                        snapshot.forEach((childSnapshot) => {
                            const withdrawal = childSnapshot.val();
                            if (withdrawal.status === 'pending') {
                                pendingCount++;
                            }
                        });
                    }
                    document.getElementById('stat-pending-withdrawals').textContent = pendingCount;
                });
                
                // Load recent activity
                loadRecentActivity();
                
                // Load system settings
                loadSystemSettings();
                
            } catch (error) {
                console.error('Error loading dashboard data:', error);
                alert('Error loading dashboard data. Please refresh.');
            }
        }

        // Load users with pagination
        function loadUsers() {
            filteredUsers = usersData;
            renderUsersTable();
        }

        // Render users table - FIXED DATA STRUCTURE
        function renderUsersTable() {
            const tbody = document.getElementById('users-table-body');
            
            if (filteredUsers.length === 0) {
                tbody.innerHTML = `
                    <tr>
                        <td colspan="8" style="text-align: center; padding: 30px;">
                            No users found
                        </td>
                    </tr>
                `;
                return;
            }
            
            const startIndex = (currentPage - 1) * usersPerPage;
            const endIndex = startIndex + usersPerPage;
            const pageUsers = filteredUsers.slice(startIndex, endIndex);
            
            tbody.innerHTML = '';
            
            pageUsers.forEach(user => {
                // FIXED: Handle both data structures
                let tokens = 0;
                let usdt = 0;
                
                if (user.appState) {
                    tokens = user.appState.tokens || 0;
                    usdt = user.appState.usdt || 0;
                } else if (user.tokens !== undefined) {
                    tokens = user.tokens || 0;
                    usdt = user.usdt || 0;
                }
                
                const row = document.createElement('tr');
                
                row.innerHTML = `
                    <td>${user.userId || user.id}</td>
                    <td>${user.name || 'Guest Bee'}</td>
                    <td>${tokens.toLocaleString()}</td>
                    <td>$${usdt.toFixed(4)}</td>
                    <td>${user.referrals || 0}</td>
                    <td>
                        <span style="
                            padding: 4px 8px;
                            border-radius: 4px;
                            background-color: ${(user.status === 'active' || !user.status) ? 'var(--green)' : 'var(--red)'};
                            color: white;
                            font-size: 12px;
                        ">
                            ${user.status || 'active'}
                        </span>
                    </td>
                    <td>${user.joinedDate ? new Date(user.joinedDate).toLocaleDateString() : 'N/A'}</td>
                    <td>
                        <button class="action-btn view-btn" onclick="viewUserDetails('${user.id}')">
                            <i class="fas fa-eye"></i>
                        </button>
                        <button class="action-btn edit-btn" onclick="editUser('${user.id}')">
                            <i class="fas fa-edit"></i>
                        </button>
                        <button class="action-btn delete-btn" onclick="deleteUser('${user.id}')">
                            <i class="fas fa-trash"></i>
                        </button>
                    </td>
                `;
                
                tbody.appendChild(row);
            });
            
            updatePaginationInfo();
        }

        // Update pagination info
        function updatePaginationInfo() {
            const totalPages = Math.ceil(filteredUsers.length / usersPerPage);
            const startIndex = (currentPage - 1) * usersPerPage + 1;
            const endIndex = Math.min(currentPage * usersPerPage, filteredUsers.length);
            
            document.getElementById('pagination-info').innerHTML = `
                Showing ${startIndex}-${endIndex} of ${filteredUsers.length} users
                ${totalPages > 1 ? `(Page ${currentPage} of ${totalPages})` : ''}
            `;
        }

        // Next page
        function nextPage() {
            const totalPages = Math.ceil(filteredUsers.length / usersPerPage);
            if (currentPage < totalPages) {
                currentPage++;
                renderUsersTable();
            }
        }

        // Previous page
        function prevPage() {
            if (currentPage > 1) {
                currentPage--;
                renderUsersTable();
            }
        }

        // Search users
        function searchUsers() {
            const searchTerm = document.getElementById('user-search').value.toLowerCase();
            
            if (!searchTerm) {
                filteredUsers = usersData;
            } else {
                filteredUsers = usersData.filter(user => 
                    (user.userId && user.userId.toLowerCase().includes(searchTerm)) ||
                    (user.name && user.name.toLowerCase().includes(searchTerm)) ||
                    (user.telegramId && user.telegramId.toString().includes(searchTerm)) ||
                    (user.email && user.email.toLowerCase().includes(searchTerm))
                );
            }
            
            currentPage = 1;
            renderUsersTable();
        }

        // View user details
        async function viewUserDetails(userId) {
            const userRef = database.ref('users/' + userId);
            const snapshot = await userRef.once('value');
            
            if (snapshot.exists()) {
                const user = snapshot.val();
                
                // Get correct data structure
                let tokens = 0;
                let usdt = 0;
                
                if (user.appState) {
                    tokens = user.appState.tokens || 0;
                    usdt = user.appState.usdt || 0;
                } else if (user.tokens !== undefined) {
                    tokens = user.tokens || 0;
                    usdt = user.usdt || 0;
                }
                
                alert(`
                    User Details:
                    ID: ${user.userId || userId}
                    Name: ${user.name || 'N/A'}
                    Telegram ID: ${user.telegramId || 'N/A'}
                    Tokens: ${tokens.toLocaleString()}
                    USDT: $${usdt.toFixed(4)}
                    Referrals: ${user.referrals || 0}
                    Ads Watched: ${user.totalAdsWatched || 0}
                    Tasks Completed: ${user.tasksCompleted || 0}
                    Joined: ${user.joinedDate || 'N/A'}
                    Last Active: ${user.lastActive || 'N/A'}
                `);
            }
        }

        // Edit user - FIXED DATA STRUCTURE
        async function editUser(userId) {
            const userRef = database.ref('users/' + userId);
            const snapshot = await userRef.once('value');
            
            if (snapshot.exists()) {
                const user = snapshot.val();
                
                // Get correct data structure
                let tokens = 0;
                let usdt = 0;
                
                if (user.appState) {
                    tokens = user.appState.tokens || 0;
                    usdt = user.appState.usdt || 0;
                } else if (user.tokens !== undefined) {
                    tokens = user.tokens || 0;
                    usdt = user.usdt || 0;
                }
                
                // Fill modal form
                document.getElementById('edit-user-id').value = user.userId || userId;
                document.getElementById('edit-user-name').value = user.name || '';
                document.getElementById('edit-user-tokens').value = tokens;
                document.getElementById('edit-user-usdt').value = usdt;
                document.getElementById('edit-user-referrals').value = user.referrals || 0;
                document.getElementById('edit-user-status').value = user.status || 'active';
                
                // Store user ID and data structure for saving
                document.getElementById('edit-user-form').dataset.userId = userId;
                document.getElementById('edit-user-form').dataset.hasAppState = !!user.appState;
                
                // Show modal
                openModal('user-edit-modal');
            }
        }

        // Save user edits - FIXED DATA STRUCTURE
        async function saveUserEdits() {
            const userId = document.getElementById('edit-user-form').dataset.userId;
            const hasAppState = document.getElementById('edit-user-form').dataset.hasAppState === 'true';
            
            if (!userId) return;
            
            const userRef = database.ref('users/' + userId);
            
            try {
                // Get current user data
                const snapshot = await userRef.once('value');
                const currentData = snapshot.exists() ? snapshot.val() : {};
                
                // Prepare updates based on data structure
                let updates = {
                    name: document.getElementById('edit-user-name').value,
                    referrals: parseInt(document.getElementById('edit-user-referrals').value) || 0,
                    status: document.getElementById('edit-user-status').value
                };
                
                // Handle tokens and USDT based on data structure
                const newTokens = parseInt(document.getElementById('edit-user-tokens').value) || 0;
                const newUSDT = parseFloat(document.getElementById('edit-user-usdt').value) || 0;
                
                if (hasAppState) {
                    updates.appState = {
                        ...(currentData.appState || {}),
                        tokens: newTokens,
                        usdt: newUSDT
                    };
                } else {
                    updates.tokens = newTokens;
                    updates.usdt = newUSDT;
                }
                
                // Update user
                await userRef.update(updates);
                
                // Log the action
                await logAdminAction(`Edited user ${userId} - Tokens: ${newTokens}, USDT: ${newUSDT}`);
                
                alert('User updated successfully!');
                closeModal('user-edit-modal');
                loadDashboardData(); // Refresh data
                
            } catch (error) {
                console.error('Error updating user:', error);
                alert('Error updating user. Please try again.');
            }
        }

        // Delete user (with confirmation)
        async function deleteUser(userId) {
            if (!confirm('Are you sure you want to delete this user? This action cannot be undone.')) {
                return;
            }
            
            try {
                const userRef = database.ref('users/' + userId);
                
                // Get user data for logging
                const snapshot = await userRef.once('value');
                const userData = snapshot.val();
                
                // Delete user
                await userRef.remove();
                
                // Also delete user's appState if exists
                const appStateRef = database.ref('appState/' + userId);
                await appStateRef.remove();
                
                // Log the action
                await logAdminAction(`Deleted user ${userId} (${userData?.name || 'Unknown'})`);
                
                alert('User deleted successfully!');
                loadDashboardData(); // Refresh data
                
            } catch (error) {
                console.error('Error deleting user:', error);
                alert('Error deleting user. Please try again.');
            }
        }

        // Load withdrawals
        async function loadWithdrawals() {
            try {
                const withdrawalsRef = database.ref('withdrawals');
                const snapshot = await withdrawalsRef.once('value');
                
                const tbody = document.getElementById('withdrawals-table-body');
                tbody.innerHTML = '';
                
                if (!snapshot.exists()) {
                    tbody.innerHTML = `
                        <tr>
                            <td colspan="7" style="text-align: center; padding: 30px;">
                                No withdrawal requests found
                            </td>
                        </tr>
                    `;
                    return;
                }
                
                snapshot.forEach((childSnapshot) => {
                    const withdrawal = childSnapshot.val();
                    const row = document.createElement('tr');
                    
                    let statusColor = 'var(--blue)';
                    if (withdrawal.status === 'completed') statusColor = 'var(--green)';
                    if (withdrawal.status === 'rejected') statusColor = 'var(--red)';
                    
                    row.innerHTML = `
                        <td>${childSnapshot.key.substring(0, 8)}</td>
                        <td>${withdrawal.userId}</td>
                        <td>$${withdrawal.amount?.toFixed(4) || '0.0000'}</td>
                        <td style="font-family: monospace;">${withdrawal.walletAddress || 'Not provided'}</td>
                        <td>
                            <span style="
                                padding: 4px 8px;
                                border-radius: 4px;
                                background-color: ${statusColor};
                                color: white;
                                font-size: 12px;
                            ">
                                ${withdrawal.status || 'pending'}
                            </span>
                        </td>
                        <td>${withdrawal.timestamp ? new Date(withdrawal.timestamp).toLocaleDateString() : 'N/A'}</td>
                        <td>
                            ${withdrawal.status === 'pending' ? `
                                <button class="action-btn edit-btn" onclick="processWithdrawal('${childSnapshot.key}', 'completed')">
                                    Approve
                                </button>
                                <button class="action-btn delete-btn" onclick="processWithdrawal('${childSnapshot.key}', 'rejected')">
                                    Reject
                                </button>
                            ` : 'Processed'}
                        </td>
                    `;
                    
                    tbody.appendChild(row);
                });
                
            } catch (error) {
                console.error('Error loading withdrawals:', error);
            }
        }

        // Process withdrawal
        async function processWithdrawal(withdrawalId, action) {
            if (!confirm(`Are you sure you want to ${action} this withdrawal?`)) {
                return;
            }
            
            try {
                const withdrawalRef = database.ref('withdrawals/' + withdrawalId);
                
                // Update withdrawal status
                await withdrawalRef.update({
                    status: action,
                    processedAt: new Date().toISOString(),
                    processedBy: ADMIN_EMAIL
                });
                
                // If approved, update user's USDT balance
                if (action === 'completed') {
                    const snapshot = await withdrawalRef.once('value');
                    const withdrawal = snapshot.val();
                    
                    // Find user and update balance
                    const userRef = database.ref('users/' + withdrawal.userId);
                    const userSnapshot = await userRef.once('value');
                    const userData = userSnapshot.val();
                    
                    if (userData) {
                        const withdrawalAmount = withdrawal.amount || 0;
                        let currentUSDT = 0;
                        
                        // Handle different data structures
                        if (userData.appState) {
                            currentUSDT = userData.appState.usdt || 0;
                            const newUSDT = Math.max(0, currentUSDT - withdrawalAmount);
                            
                            await userRef.update({
                                'appState.usdt': newUSDT
                            });
                        } else if (userData.usdt !== undefined) {
                            currentUSDT = userData.usdt || 0;
                            const newUSDT = Math.max(0, currentUSDT - withdrawalAmount);
                            
                            await userRef.update({
                                usdt: newUSDT
                            });
                        }
                    }
                }
                
                // Log the action
                await logAdminAction(`${action} withdrawal ${withdrawalId.substring(0, 8)}`);
                
                alert(`Withdrawal ${action} successfully!`);
                loadWithdrawals(); // Refresh table
                loadDashboardData(); // Refresh stats
                
            } catch (error) {
                console.error('Error processing withdrawal:', error);
                alert('Error processing withdrawal. Please try again.');
            }
        }

        // Load referrals
        async function loadReferrals() {
            try {
                const usersRef = database.ref('users');
                const snapshot = await usersRef.once('value');
                
                let topReferrers = [];
                let totalReferrals = 0;
                
                if (snapshot.exists()) {
                    snapshot.forEach((childSnapshot) => {
                        const user = childSnapshot.val();
                        const referrals = user.referrals || 0;
                        totalReferrals += referrals;
                        
                        if (referrals > 0) {
                            topReferrers.push({
                                name: user.name || 'Anonymous',
                                userId: user.userId || childSnapshot.key,
                                referrals: referrals,
                                earnings: (referrals * (systemSettings.referralReward || 10))
                            });
                        }
                    });
                }
                
                // Sort by referrals
                topReferrers.sort((a, b) => b.referrals - a.referrals);
                
                // Display top referrers
                const topReferrersDiv = document.getElementById('top-referrers');
                if (topReferrers.length > 0) {
                    let html = '';
                    topReferrers.slice(0, 5).forEach((referrer, index) => {
                        html += `
                            <div style="display: flex; justify-content: space-between; margin-bottom: 8px; padding-bottom: 8px; border-bottom: 1px solid var(--admin-border);">
                                <div>
                                    <strong>${index + 1}. ${referrer.name}</strong><br>
                                    <small>${referrer.userId}</small>
                                </div>
                                <div style="text-align: right;">
                                    <div>${referrer.referrals} referrals</div>
                                    <small>${referrer.earnings} tokens earned</small>
                                </div>
                            </div>
                        `;
                    });
                    topReferrersDiv.innerHTML = html;
                } else {
                    topReferrersDiv.innerHTML = 'No referral data available';
                }
                
                // Display referral stats
                const referralStatsDiv = document.getElementById('referral-stats');
                referralStatsDiv.innerHTML = `
                    <div style="margin-bottom: 10px;">
                        <strong>Total Referrals:</strong> ${totalReferrals}
                    </div>
                    <div style="margin-bottom: 10px;">
                        <strong>Reward per Referral:</strong> ${systemSettings.referralReward || 10} tokens
                    </div>
                    <div style="margin-bottom: 10px;">
                        <strong>Total Tokens Distributed:</strong> ${totalReferrals * (systemSettings.referralReward || 10)} tokens
                    </div>
                `;
                
            } catch (error) {
                console.error('Error loading referrals:', error);
            }
        }

        // Load system settings
        async function loadSystemSettings() {
            try {
                const settingsRef = database.ref('systemSettings');
                const snapshot = await settingsRef.once('value');
                
                if (snapshot.exists()) {
                    systemSettings = snapshot.val();
                    
                    // Update form fields
                    document.getElementById('token-rate').value = systemSettings.tokenRate || 0.001;
                    document.getElementById('daily-airdrop').value = systemSettings.dailyAirdrop || 50;
                    document.getElementById('ad-reward').value = systemSettings.adReward || 10;
                    document.getElementById('task-reward').value = systemSettings.taskReward || 50;
                    document.getElementById('referral-reward').value = systemSettings.referralReward || 10;
                    document.getElementById('min-referrals').value = systemSettings.minReferrals || 20;
                    document.getElementById('min-withdrawal').value = systemSettings.minWithdrawal || 1.0;
                    document.getElementById('referral-link-base').value = systemSettings.referralLinkBase || 'https://t.me/your_bot_or_app?start=';
                    document.getElementById('maintenance-message').value = systemSettings.maintenanceMessage || 'System is running normally...';
                } else {
                    // Use default values
                    systemSettings = {
                        tokenRate: 0.001,
                        dailyAirdrop: 50,
                        adReward: 10,
                        taskReward: 50,
                        referralReward: 10,
                        minReferrals: 20,
                        minWithdrawal: 1.0,
                        referralLinkBase: 'https://t.me/your_bot_or_app?start=',
                        maintenanceMessage: 'System is running normally...',
                        lastUpdated: new Date().toISOString()
                    };
                    
                    // Save default settings
                    await settingsRef.set(systemSettings);
                    
                    // Update form fields
                    loadSystemSettings(); // Reload
                }
                
                // Also load these settings to a more accessible location for main app
                await updateGlobalSettingsForUsers();
                
                updateAllUserStats();
                
            } catch (error) {
                console.error('Error loading system settings:', error);
            }
        }

        // Save system settings
        async function saveSystemSettings() {
            try {
                const settingsRef = database.ref('systemSettings');
                
                const updatedSettings = {
                    tokenRate: parseFloat(document.getElementById('token-rate').value) || 0.001,
                    dailyAirdrop: parseInt(document.getElementById('daily-airdrop').value) || 50,
                    adReward: parseInt(document.getElementById('ad-reward').value) || 10,
                    taskReward: parseInt(document.getElementById('task-reward').value) || 50,
                    referralReward: parseInt(document.getElementById('referral-reward').value) || 10,
                    minReferrals: parseInt(document.getElementById('min-referrals').value) || 20,
                    minWithdrawal: parseFloat(document.getElementById('min-withdrawal').value) || 1.0,
                    referralLinkBase: document.getElementById('referral-link-base').value || 'https://t.me/your_bot_or_app?start=',
                    maintenanceMessage: document.getElementById('maintenance-message').value || 'System is running normally...',
                    lastUpdated: new Date().toISOString(),
                    updatedBy: ADMIN_EMAIL
                };
                
                // Save settings
                await settingsRef.set(updatedSettings);
                systemSettings = updatedSettings;
                
                // Also update in a location accessible to main app
                await updateGlobalSettingsForUsers();
                
                // Log the action
                await logAdminAction('Updated system settings');
                
                alert('System settings saved successfully!');
                updateAllUserStats();
                
            } catch (error) {
                console.error('Error saving system settings:', error);
                alert('Error saving settings. Please try again.');
            }
        }

        // Update global settings for user app
        async function updateGlobalSettingsForUsers() {
            try {
                // Save settings to a more accessible location for main app
                const globalSettingsRef = database.ref('globalSettings');
                await globalSettingsRef.set(systemSettings);
                
                console.log('Global settings updated for user app');
            } catch (error) {
                console.error('Error updating global settings:', error);
            }
        }

        // Update all user statistics
        async function updateAllUserStats() {
            loadDashboardData();
        }

        // Load recent activity
        async function loadRecentActivity() {
            try {
                const logsRef = database.ref('adminLogs');
                const snapshot = await logsRef.limitToLast(10).once('value');
                
                const activityDiv = document.getElementById('recent-activity');
                
                if (!snapshot.exists()) {
                    activityDiv.innerHTML = '<p>No recent activity</p>';
                    return;
                }
                
                let html = '';
                const logs = [];
                
                snapshot.forEach((childSnapshot) => {
                    logs.push(childSnapshot.val());
                });
                
                // Sort by timestamp (newest first)
                logs.sort((a, b) => new Date(b.timestamp) - new Date(a.timestamp));
                
                // Display logs
                logs.slice(0, 5).forEach(log => {
                    const timeAgo = getTimeAgo(log.timestamp);
                    html += `
                        <div style="margin-bottom: 10px; padding-bottom: 10px; border-bottom: 1px solid var(--admin-border);">
                            <div style="font-weight: bold;">${log.action}</div>
                            <small style="color: #94A3B8;">${timeAgo} by ${log.admin || 'System'}</small>
                        </div>
                    `;
                });
                
                activityDiv.innerHTML = html;
                
            } catch (error) {
                console.error('Error loading activity logs:', error);
            }
        }

        // Load activity logs
        async function loadActivityLogs() {
            try {
                const logsRef = database.ref('adminLogs');
                const snapshot = await logsRef.once('value');
                
                const logsDiv = document.getElementById('activity-logs');
                
                if (!snapshot.exists()) {
                    logsDiv.innerHTML = '<p>No activity logs found</p>';
                    return;
                }
                
                let html = '<div style="display: flex; flex-direction: column; gap: 10px;">';
                const logs = [];
                
                snapshot.forEach((childSnapshot) => {
                    logs.push({
                        id: childSnapshot.key,
                        ...childSnapshot.val()
                    });
                });
                
                // Sort by timestamp (newest first)
                logs.sort((a, b) => new Date(b.timestamp) - new Date(a.timestamp));
                
                // Display logs
                logs.forEach(log => {
                    const time = new Date(log.timestamp).toLocaleString();
                    html += `
                        <div style="
                            padding: 15px;
                            background-color: rgba(255,255,255,0.05);
                            border-radius: 8px;
                            border-left: 4px solid var(--primary-yellow);
                        ">
                            <div style="display: flex; justify-content: space-between; margin-bottom: 5px;">
                                <strong>${log.action}</strong>
                                <small style="color: #94A3B8;">${time}</small>
                            </div>
                            <div style="color: #94A3B8; font-size: 14px;">
                                Admin: ${log.admin || 'System'} | IP: ${log.ip || 'N/A'}
                            </div>
                        </div>
                    `;
                });
                
                html += '</div>';
                logsDiv.innerHTML = html;
                
            } catch (error) {
                console.error('Error loading activity logs:', error);
            }
        }

        // Filter logs
        function filterLogs(type) {
            alert(`Filtering by ${type} - This would filter the logs in a real implementation`);
        }

        // Search logs
        function searchLogs() {
            const term = document.getElementById('log-search').value;
            alert(`Searching for: ${term}`);
        }

        // Log admin action
        async function logAdminAction(action) {
            try {
                const logsRef = database.ref('adminLogs');
                await logsRef.push({
                    action: action,
                    admin: ADMIN_EMAIL,
                    timestamp: new Date().toISOString(),
                    ip: 'N/A'
                });
            } catch (error) {
                console.error('Error logging action:', error);
            }
        }

        // Utility functions
        function openModal(modalId) {
            document.getElementById(modalId).style.display = 'flex';
        }

        function closeModal(modalId) {
            document.getElementById(modalId).style.display = 'none';
        }

        function getTimeAgo(timestamp) {
            const now = new Date();
            const past = new Date(timestamp);
            const diffMs = now - past;
            
            const diffMins = Math.floor(diffMs / 60000);
            const diffHours = Math.floor(diffMs / 3600000);
            const diffDays = Math.floor(diffMs / 86400000);
            
            if (diffMins < 60) {
                return `${diffMins} minute${diffMins !== 1 ? 's' : ''} ago`;
            } else if (diffHours < 24) {
                return `${diffHours} hour${diffHours !== 1 ? 's' : ''} ago`;
            } else {
                return `${diffDays} day${diffDays !== 1 ? 's' : ''} ago`;
            }
        }

        // Close modal when clicking outside
        window.onclick = function(event) {
            const modals = document.querySelectorAll('.modal');
            modals.forEach(modal => {
                if (event.target === modal) {
                    modal.style.display = 'none';
                }
            });
        };
    </script>
</body>
</html>
