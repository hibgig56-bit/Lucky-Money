<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Bee Token Admin Panel</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        /* Base CSS - Mobile First Approach */
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }
        
        :root {
            --primary-yellow: #FFD700;
            --secondary-yellow: #FFEE58;
            --dark-yellow: #F9A825;
            --black: #1A1A1A;
            --white: #FFFFFF;
            --gray: #F5F5F5;
            --green: #4CAF50;
            --red: #F44336;
            --blue: #2196F3;
            --admin-bg: #0F172A;
            --admin-text: #E2E8F0;
            --admin-card: #1E293B;
            --admin-border: #334155;
        }
        
        body {
            background-color: var(--admin-bg);
            color: var(--admin-text);
            min-height: 100vh;
            overflow-x: hidden;
        }
        
        /* Mobile Menu Toggle */
        .mobile-menu-toggle {
            display: none;
            position: fixed;
            top: 20px;
            left: 20px;
            z-index: 1000;
            background: var(--primary-yellow);
            color: var(--black);
            border: none;
            border-radius: 50%;
            width: 50px;
            height: 50px;
            font-size: 20px;
            cursor: pointer;
            box-shadow: 0 2px 10px rgba(0,0,0,0.3);
        }
        
        /* Login Page - Mobile Responsive */
        .login-container {
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 100vh;
            background: linear-gradient(135deg, var(--admin-bg) 0%, #1E3A8A 100%);
            padding: 20px;
        }
        
        .login-box {
            background-color: var(--admin-card);
            padding: 25px;
            border-radius: 15px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.3);
            width: 100%;
            max-width: 400px;
            border: 1px solid var(--admin-border);
        }
        
        /* Admin Dashboard - Mobile Responsive */
        .admin-container {
            display: none;
            min-height: 100vh;
        }
        
        .sidebar {
            width: 280px;
            background-color: var(--admin-card);
            position: fixed;
            height: 100vh;
            overflow-y: auto;
            border-right: 1px solid var(--admin-border);
            z-index: 900;
            transform: translateX(-100%);
            transition: transform 0.3s ease;
        }
        
        .sidebar.active {
            transform: translateX(0);
        }
        
        .sidebar-header {
            padding: 20px;
            text-align: center;
            border-bottom: 1px solid var(--admin-border);
        }
        
        .main-content {
            padding: 20px;
            width: 100%;
            transition: margin-left 0.3s ease;
        }
        
        .main-content.sidebar-open {
            margin-left: 280px;
        }
        
        /* Top Bar Mobile */
        .top-bar {
            display: flex;
            flex-direction: column;
            gap: 15px;
            padding: 15px;
            background-color: var(--admin-card);
            border-radius: 10px;
            margin-bottom: 20px;
            border: 1px solid var(--admin-border);
        }
        
        @media (min-width: 768px) {
            .top-bar {
                flex-direction: row;
                justify-content: space-between;
                align-items: center;
            }
        }
        
        /* Stats Grid Mobile */
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 15px;
            margin-bottom: 20px;
        }
        
        .stat-card {
            background-color: var(--admin-card);
            padding: 20px;
            border-radius: 12px;
            border: 1px solid var(--admin-border);
        }
        
        .stat-card .value {
            font-size: 24px;
        }
        
        .stat-card i {
            font-size: 36px;
        }
        
        /* Content Sections Mobile */
        .content-section {
            display: none;
            background-color: var(--admin-card);
            padding: 20px;
            border-radius: 12px;
            border: 1px solid var(--admin-border);
            margin-bottom: 20px;
            overflow-x: auto;
        }
        
        .content-section.active {
            display: block;
        }
        
        /* Tables Mobile */
        .user-table-container {
            overflow-x: auto;
            -webkit-overflow-scrolling: touch;
        }
        
        .user-table {
            min-width: 700px;
        }
        
        /* Form Groups Mobile */
        .settings-form {
            display: flex;
            flex-direction: column;
            gap: 15px;
        }
        
        .form-group {
            margin-bottom: 15px;
        }
        
        /* Modal Mobile */
        .modal-content {
            width: 95%;
            margin: 20px;
            padding: 20px;
        }
        
        /* Mobile Specific Styles */
        @media (max-width: 767px) {
            .mobile-menu-toggle {
                display: block;
            }
            
            .sidebar {
                width: 85%;
                max-width: 300px;
            }
            
            .main-content.sidebar-open {
                margin-left: 0;
                transform: translateX(85%);
            }
            
            .stat-card {
                padding: 15px;
            }
            
            .stat-card .value {
                font-size: 20px;
            }
            
            .stats-grid {
                grid-template-columns: 1fr 1fr;
            }
            
            .section-header {
                flex-direction: column;
                gap: 15px;
                align-items: flex-start;
            }
            
            .search-box {
                width: 100%;
            }
            
            .search-box input {
                flex: 1;
            }
            
            .action-btn {
                padding: 4px 8px;
                font-size: 12px;
                margin-bottom: 5px;
            }
            
            .user-info {
                flex-direction: column;
                gap: 10px;
                align-items: flex-start;
            }
            
            .menu-item {
                padding: 12px 20px;
            }
        }
        
        @media (max-width: 480px) {
            .stats-grid {
                grid-template-columns: 1fr;
            }
            
            .login-box {
                padding: 20px;
            }
            
            .menu-item {
                padding: 10px 15px;
            }
        }
        
        /* Bot Token Management Page Styles */
        .token-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }
        
        .token-card {
            background: var(--admin-card);
            border: 1px solid var(--admin-border);
            border-radius: 10px;
            padding: 20px;
        }
        
        .token-card h4 {
            color: var(--primary-yellow);
            margin-bottom: 15px;
            padding-bottom: 10px;
            border-bottom: 1px solid var(--admin-border);
        }
        
        .token-input-group {
            margin-bottom: 15px;
        }
        
        .token-input-group label {
            display: block;
            margin-bottom: 5px;
            color: var(--admin-text);
            font-size: 14px;
        }
        
        .token-input-group input {
            width: 100%;
            padding: 10px;
            border: 1px solid var(--admin-border);
            border-radius: 5px;
            background: rgba(255,255,255,0.05);
            color: var(--admin-text);
        }
        
        .token-preview {
            background: rgba(255,215,0,0.1);
            border: 1px dashed var(--primary-yellow);
            border-radius: 8px;
            padding: 15px;
            margin-top: 15px;
        }
        
        .referral-link-display {
            background: var(--admin-bg);
            border-radius: 5px;
            padding: 10px;
            margin: 10px 0;
            font-family: monospace;
            word-break: break-all;
            font-size: 12px;
        }
        
        .copy-btn {
            background: var(--primary-yellow);
            color: var(--black);
            border: none;
            padding: 8px 15px;
            border-radius: 5px;
            cursor: pointer;
            font-weight: bold;
            margin-top: 10px;
            width: 100%;
        }
        
        .save-token-btn {
            background: linear-gradient(135deg, var(--primary-yellow), var(--dark-yellow));
            color: var(--black);
            border: none;
            padding: 12px 20px;
            border-radius: 8px;
            cursor: pointer;
            font-weight: bold;
            margin-top: 15px;
            width: 100%;
        }
        
        /* Existing styles remain... */
        
        .loading-spinner {
            display: inline-block;
            width: 20px;
            height: 20px;
            border: 3px solid rgba(255, 255, 255, 0.3);
            border-radius: 50%;
            border-top-color: var(--primary-yellow);
            animation: spin 1s ease-in-out infinite;
        }
        
        @keyframes spin {
            to { transform: rotate(360deg); }
        }
    </style>
</head>
<body>
    <!-- Alert Container -->
    <div class="alert-container" id="alert-container"></div>

    <!-- Confirm Modal -->
    <div class="confirm-modal" id="confirm-modal">
        <div class="confirm-content">
            <div class="confirm-message" id="confirm-message"></div>
            <div class="confirm-buttons">
                <button class="confirm-btn confirm-cancel" id="confirm-cancel">Cancel</button>
                <button class="confirm-btn confirm-ok" id="confirm-ok">OK</button>
            </div>
        </div>
    </div>

    <!-- Login Page -->
    <div class="login-container" id="login-page">
        <div class="login-box">
            <div class="login-logo">
                <i class="fas fa-bee"></i>
                <h2>Bee Token Admin</h2>
            </div>
            <form class="login-form" id="login-form">
                <input type="email" id="admin-email" placeholder="Admin Email" required>
                <input type="password" id="admin-password" placeholder="Password" required>
                <button type="submit" class="login-button" id="login-btn">Login to Dashboard</button>
                <div class="error-message" id="login-error"></div>
            </form>
        </div>
    </div>

    <!-- Admin Dashboard -->
    <div class="admin-container" id="admin-dashboard">
        <!-- Mobile Menu Button -->
        <button class="mobile-menu-toggle" id="mobile-menu-toggle">
            <i class="fas fa-bars"></i>
        </button>

        <!-- Sidebar -->
        <div class="sidebar" id="sidebar">
            <div class="sidebar-header">
                <h2><i class="fas fa-bee"></i> <span>Bee Admin</span></h2>
            </div>
            <div class="sidebar-menu">
                <div class="menu-item active" data-section="dashboard">
                    <i class="fas fa-tachometer-alt"></i>
                    <span>Dashboard</span>
                </div>
                <div class="menu-item" data-section="users">
                    <i class="fas fa-users"></i>
                    <span>User Management</span>
                </div>
                <div class="menu-item" data-section="settings">
                    <i class="fas fa-cog"></i>
                    <span>System Settings</span>
                </div>
                <div class="menu-item" data-section="withdrawals">
                    <i class="fas fa-wallet"></i>
                    <span>Withdrawals</span>
                </div>
                <div class="menu-item" data-section="referrals">
                    <i class="fas fa-user-friends"></i>
                    <span>Referral System</span>
                </div>
                <div class="menu-item" data-section="notifications">
                    <i class="fas fa-bell"></i>
                    <span>Send Notification</span>
                </div>
                <!-- NEW PAGE: Bot Token Management -->
                <div class="menu-item" data-section="token-management">
                    <i class="fas fa-link"></i>
                    <span>Token & Links</span>
                </div>
                <div class="menu-item" data-section="logs">
                    <i class="fas fa-history"></i>
                    <span>Activity Logs</span>
                </div>
            </div>
        </div>

        <!-- Main Content -->
        <div class="main-content" id="main-content">
            <!-- Top Bar -->
            <div class="top-bar">
                <div>
                    <h1>Admin Dashboard</h1>
                    <p id="current-date">Loading...</p>
                </div>
                <div class="user-info">
                    <span id="admin-email-display">admin@bee.com</span>
                    <button class="logout-btn" id="admin-logout-btn">
                        <i class="fas fa-sign-out-alt"></i> Logout
                    </button>
                </div>
            </div>

            <!-- Dashboard Statistics -->
            <div class="stats-grid">
                <!-- Same stats cards as before -->
                <div class="stat-card">
                    <div>
                        <div class="label">Total Users</div>
                        <div class="value" id="stat-total-users">0</div>
                    </div>
                    <i class="fas fa-users"></i>
                </div>
                <div class="stat-card">
                    <div>
                        <div class="label">Total Tokens</div>
                        <div class="value" id="stat-total-tokens">0</div>
                    </div>
                    <i class="fas fa-coins"></i>
                </div>
                <div class="stat-card">
                    <div>
                        <div class="label">Total USDT</div>
                        <div class="value" id="stat-total-usdt">$0.00</div>
                    </div>
                    <i class="fas fa-dollar-sign"></i>
                </div>
                <div class="stat-card">
                    <div>
                        <div class="label">Total Referrals</div>
                        <div class="value" id="stat-total-referrals">0</div>
                    </div>
                    <i class="fas fa-user-friends"></i>
                </div>
                <div class="stat-card">
                    <div>
                        <div class="label">Pending Withdrawals</div>
                        <div class="value" id="stat-pending-withdrawals">0</div>
                    </div>
                    <i class="fas fa-wallet"></i>
                </div>
                <div class="stat-card">
                    <div>
                        <div class="label">Active Today</div>
                        <div class="value" id="stat-active-today">0</div>
                    </div>
                    <i class="fas fa-chart-line"></i>
                </div>
            </div>

            <!-- Dashboard Section -->
            <div class="content-section active" id="dashboard-section">
                <div class="section-header">
                    <h3><i class="fas fa-tachometer-alt"></i> Dashboard Overview</h3>
                </div>
                <div style="display: grid; grid-template-columns: 1fr; gap: 20px;">
                    <div style="background-color: rgba(255,255,255,0.05); padding: 20px; border-radius: 8px;">
                        <h4 style="margin-bottom: 15px; color: var(--primary-yellow);">Recent Activity</h4>
                        <div id="recent-activity">
                            <p>Loading recent activity...</p>
                        </div>
                    </div>
                    <div style="background-color: rgba(255,255,255,0.05); padding: 20px; border-radius: 8px;">
                        <h4 style="margin-bottom: 15px; color: var(--primary-yellow);">Quick Actions</h4>
                        <div style="display: flex; flex-direction: column; gap: 10px;">
                            <button class="action-btn view-btn" onclick="showSection('users')">
                                <i class="fas fa-users"></i> View All Users
                            </button>
                            <button class="action-btn edit-btn" onclick="showSection('withdrawals')">
                                <i class="fas fa-wallet"></i> Process Withdrawals
                            </button>
                            <button class="action-btn edit-btn" onclick="refreshAllData()">
                                <i class="fas fa-sync"></i> Refresh Statistics
                            </button>
                        </div>
                    </div>
                </div>
            </div>

            <!-- NEW PAGE: Token & Links Management -->
            <div class="content-section" id="token-management-section">
                <div class="section-header">
                    <h3><i class="fas fa-link"></i> Token & Referral Links Management</h3>
                    <p>Manage bot tokens and generate referral links</p>
                </div>

                <div class="token-grid">
                    <!-- Telegram Bot Token Configuration -->
                    <div class="token-card">
                        <h4><i class="fab fa-telegram"></i> Telegram Bot Configuration</h4>
                        <div class="token-input-group">
                            <label>Bot Token</label>
                            <input type="text" id="telegram-bot-token" placeholder="Enter Telegram Bot Token">
                        </div>
                        <div class="token-input-group">
                            <label>Bot Username</label>
                            <input type="text" id="telegram-bot-username" placeholder="@YourBotUsername">
                        </div>
                        <div class="token-input-group">
                            <label>Bot Start Command</label>
                            <input type="text" id="telegram-start-command" value="/start">
                        </div>
                        <div class="token-preview">
                            <strong>Generated Bot Link:</strong>
                            <div class="referral-link-display" id="telegram-bot-link-preview">
                                https://t.me/YOUR_BOT?start=
                            </div>
                            <button class="copy-btn" onclick="copyToClipboard('telegram-bot-link-preview')">
                                <i class="fas fa-copy"></i> Copy Link
                            </button>
                        </div>
                        <button class="save-token-btn" onclick="saveTelegramBotConfig()">
                            <i class="fas fa-save"></i> Save Telegram Bot Settings
                        </button>
                    </div>

                    <!-- Referral Link Generator -->
                    <div class="token-card">
                        <h4><i class="fas fa-user-plus"></i> Referral Link Generator</h4>
                        <div class="token-input-group">
                            <label>Base Referral URL</label>
                            <input type="text" id="referral-base-url" 
                                   placeholder="https://t.me/YourBot?start=ref_" 
                                   value="https://t.me/YourBot?start=ref_">
                        </div>
                        <div class="token-input-group">
                            <label>Referral Prefix</label>
                            <input type="text" id="referral-prefix" value="ref_">
                        </div>
                        <div class="token-input-group">
                            <label>Referral Code Length</label>
                            <input type="number" id="referral-code-length" min="4" max="20" value="8">
                        </div>
                        
                        <div style="margin: 15px 0;">
                            <button class="action-btn edit-btn" onclick="generateReferralLink()" 
                                    style="width: 100%; padding: 10px;">
                                <i class="fas fa-bolt"></i> Generate Sample Link
                            </button>
                        </div>
                        
                        <div class="token-preview">
                            <strong>Sample Referral Link:</strong>
                            <div class="referral-link-display" id="sample-referral-link">
                                https://t.me/YourBot?start=ref_ABC123
                            </div>
                            <button class="copy-btn" onclick="copyToClipboard('sample-referral-link')">
                                <i class="fas fa-copy"></i> Copy Link
                            </button>
                        </div>
                    </div>

                    <!-- User Specific Referral Management -->
                    <div class="token-card">
                        <h4><i class="fas fa-users"></i> User Referral Management</h4>
                        <div class="token-input-group">
                            <label>Search User by ID or Email</label>
                            <input type="text" id="user-referral-search" placeholder="Enter User ID or Email">
                        </div>
                        <div style="display: flex; gap: 10px;">
                            <button class="action-btn view-btn" onclick="findUserForReferral()" style="flex: 1;">
                                Find User
                            </button>
                            <button class="action-btn edit-btn" onclick="resetReferralSearch()" style="flex: 1;">
                                Reset
                            </button>
                        </div>
                        
                        <div id="user-referral-details" style="margin-top: 15px; display: none;">
                            <div class="token-preview">
                                <strong>User Details:</strong>
                                <div id="referral-user-info"></div>
                                <div style="margin-top: 10px;">
                                    <strong>Current Referral Code:</strong>
                                    <div class="referral-link-display" id="current-referral-code"></div>
                                </div>
                                <div style="margin-top: 10px;">
                                    <strong>Generate New Referral Code:</strong>
                                    <input type="text" id="new-referral-code" placeholder="Enter new referral code" 
                                           style="width: 100%; padding: 8px; margin: 5px 0;">
                                    <button class="action-btn edit-btn" onclick="updateUserReferralCode()" 
                                            style="width: 100%; margin-top: 10px;">
                                        <i class="fas fa-sync"></i> Update Referral Code
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Referral Statistics -->
                    <div class="token-card">
                        <h4><i class="fas fa-chart-bar"></i> Referral Performance</h4>
                        <div id="referral-performance-stats">
                            <p>Loading referral statistics...</p>
                        </div>
                        <div style="margin-top: 15px;">
                            <button class="action-btn view-btn" onclick="loadReferralPerformance()" 
                                    style="width: 100%; padding: 10px;">
                                <i class="fas fa-refresh"></i> Refresh Stats
                            </button>
                        </div>
                    </div>
                </div>

                <!-- Bulk Referral Link Generator -->
                <div class="token-card" style="margin-top: 20px;">
                    <h4><i class="fas fa-cogs"></i> Bulk Referral Link Generator</h4>
                    <div class="token-input-group">
                        <label>Number of Links to Generate</label>
                        <input type="number" id="bulk-link-count" min="1" max="100" value="10">
                    </div>
                    <div class="token-input-group">
                        <label>Prefix for All Links</label>
                        <input type="text" id="bulk-link-prefix" value="promo_">
                    </div>
                    <button class="save-token-btn" onclick="generateBulkReferralLinks()">
                        <i class="fas fa-bolt"></i> Generate Bulk Links
                    </button>
                    
                    <div id="bulk-links-result" style="margin-top: 20px; display: none;">
                        <h5>Generated Links:</h5>
                        <div class="referral-link-display" id="bulk-links-display" 
                             style="max-height: 200px; overflow-y: auto;"></div>
                        <button class="copy-btn" onclick="copyAllBulkLinks()" style="margin-top: 10px;">
                            <i class="fas fa-copy"></i> Copy All Links
                        </button>
                    </div>
                </div>
            </div>

            <!-- Existing sections remain same (users, settings, withdrawals, etc.) -->
            <!-- ... Previous sections code ... -->

        </div>
    </div>

    <!-- Firebase SDKs -->
    <script type="module">
        // Firebase Configuration
        const firebaseConfig = {
            apiKey: "AIzaSyASMBf-fL9tJOj2sgKdpVK77TYRMga1bag",
            authDomain: "money-host-56ee9.firebaseapp.com",
            databaseURL: "https://money-host-56ee9-default-rtdb.firebaseio.com",
            projectId: "money-host-56ee9",
            storageBucket: "money-host-56ee9.firebasestorage.app",
            messagingSenderId: "701262930342",
            appId: "1:701262930342:web:a8c49ea25b730332ff2f67"
        };

        // Firebase SDK Imports
        import { initializeApp } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-app.js";
        import { 
            getAuth, 
            onAuthStateChanged, 
            signInWithEmailAndPassword, 
            signOut 
        } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-auth.js";
        import { 
            getFirestore, 
            collection, 
            doc, 
            getDoc, 
            getDocs,
            setDoc, 
            updateDoc, 
            query, 
            where, 
            onSnapshot, 
            addDoc, 
            serverTimestamp 
        } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore.js";

        // Initialize Firebase
        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);

        // Admin UID
        const ADMIN_UIDS = ["3jTr4Bc6bAbfBaMgJvBzniJPMWq1"];

        // Global variables
        let currentAdmin = null;
        let usersData = [];
        let filteredUsers = [];
        let currentPage = 1;
        const usersPerPage = 20;

        // Initialize Admin Panel
        document.addEventListener('DOMContentLoaded', function() {
            updateCurrentDate();
            setupMenuHandlers();
            setupLoginForm();
            setupEventListeners();
            setupMobileMenu();
            
            // Check if admin is already logged in
            onAuthStateChanged(auth, handleAuthStateChange);
        });

        // Setup Mobile Menu
        function setupMobileMenu() {
            const mobileToggle = document.getElementById('mobile-menu-toggle');
            const sidebar = document.getElementById('sidebar');
            const mainContent = document.getElementById('main-content');
            
            mobileToggle.addEventListener('click', function() {
                sidebar.classList.toggle('active');
                mainContent.classList.toggle('sidebar-open');
            });
            
            // Close sidebar when clicking outside on mobile
            mainContent.addEventListener('click', function() {
                if (window.innerWidth <= 768 && sidebar.classList.contains('active')) {
                    sidebar.classList.remove('active');
                    mainContent.classList.remove('sidebar-open');
                }
            });
            
            // Handle window resize
            window.addEventListener('resize', function() {
                if (window.innerWidth > 768) {
                    sidebar.classList.add('active');
                    mainContent.classList.add('sidebar-open');
                    mobileToggle.style.display = 'none';
                } else {
                    mobileToggle.style.display = 'block';
                    sidebar.classList.remove('active');
                    mainContent.classList.remove('sidebar-open');
                }
            });
            
            // Initial state
            if (window.innerWidth > 768) {
                sidebar.classList.add('active');
                mainContent.classList.add('sidebar-open');
                mobileToggle.style.display = 'none';
            }
        }

        // Handle authentication state change
        async function handleAuthStateChange(user) {
            if (user && ADMIN_UIDS.includes(user.uid)) {
                currentAdmin = user;
                showAdminDashboard();
                loadDashboardData();
            } else {
                showLoginPage();
            }
        }

        // Show section with mobile support
        function showSection(section) {
            // Close mobile menu if open
            if (window.innerWidth <= 768) {
                document.getElementById('sidebar').classList.remove('active');
                document.getElementById('main-content').classList.remove('sidebar-open');
            }
            
            document.querySelectorAll('.content-section').forEach(sec => {
                sec.classList.remove('active');
            });
            
            document.querySelectorAll('.menu-item').forEach(item => {
                item.classList.remove('active');
            });
            
            // Activate menu item
            document.querySelector(`[data-section="${section}"]`).classList.add('active');
            
            // Show section
            document.getElementById(section + '-section').classList.add('active');
            
            // Load section data
            switch(section) {
                case 'users':
                    loadUsers();
                    break;
                case 'withdrawals':
                    loadWithdrawals();
                    break;
                case 'referrals':
                    loadReferrals();
                    break;
                case 'logs':
                    loadActivityLogs();
                    break;
                case 'settings':
                    loadSystemSettings();
                    break;
                case 'token-management':
                    loadTokenManagementData();
                    break;
                case 'notifications':
                    // Clear notification form
                    document.getElementById('notification-title').value = '';
                    document.getElementById('notification-message').value = '';
                    break;
            }
        }

        // Load Token Management Data
        async function loadTokenManagementData() {
            try {
                // Load Telegram bot configuration
                const botConfigRef = doc(db, "config", "telegramBot");
                const botConfigSnap = await getDoc(botConfigRef);
                
                if (botConfigSnap.exists()) {
                    const botConfig = botConfigSnap.data();
                    document.getElementById('telegram-bot-token').value = botConfig.token || '';
                    document.getElementById('telegram-bot-username').value = botConfig.username || '';
                    document.getElementById('telegram-start-command').value = botConfig.startCommand || '/start';
                    
                    // Update preview
                    updateTelegramBotLinkPreview();
                }
                
                // Load referral configuration
                const referralConfigRef = doc(db, "config", "referralSettings");
                const referralConfigSnap = await getDoc(referralConfigRef);
                
                if (referralConfigSnap.exists()) {
                    const referralConfig = referralConfigSnap.data();
                    document.getElementById('referral-base-url').value = referralConfig.baseUrl || 'https://t.me/YourBot?start=ref_';
                    document.getElementById('referral-prefix').value = referralConfig.prefix || 'ref_';
                    document.getElementById('referral-code-length').value = referralConfig.codeLength || 8;
                }
                
                // Load referral performance stats
                loadReferralPerformance();
                
            } catch (error) {
                console.error('Error loading token management data:', error);
                showAlert('Error loading token data', 'error');
            }
        }

        // Update Telegram Bot Link Preview
        function updateTelegramBotLinkPreview() {
            const username = document.getElementById('telegram-bot-username').value;
            const startCommand = document.getElementById('telegram-start-command').value;
            
            let botLink = 'https://t.me/';
            
            if (username) {
                if (username.startsWith('@')) {
                    botLink += username.substring(1);
                } else {
                    botLink += username;
                }
                
                if (startCommand) {
                    botLink += `?${startCommand.replace('/', '')}=`;
                } else {
                    botLink += '?start=';
                }
            }
            
            document.getElementById('telegram-bot-link-preview').textContent = botLink;
        }

        // Save Telegram Bot Configuration
        async function saveTelegramBotConfig() {
            try {
                const botConfigRef = doc(db, "config", "telegramBot");
                
                const botConfig = {
                    token: document.getElementById('telegram-bot-token').value,
                    username: document.getElementById('telegram-bot-username').value,
                    startCommand: document.getElementById('telegram-start-command').value,
                    updatedAt: serverTimestamp(),
                    updatedBy: currentAdmin.uid
                };
                
                await setDoc(botConfigRef, botConfig, { merge: true });
                
                // Update preview
                updateTelegramBotLinkPreview();
                
                // Log the action
                await logAdminAction('Updated Telegram bot configuration');
                
                showAlert('Telegram bot configuration saved successfully!', 'success');
                
            } catch (error) {
                console.error('Error saving bot config:', error);
                showAlert('Error saving bot configuration', 'error');
            }
        }

        // Generate Referral Link
        function generateReferralLink() {
            const baseUrl = document.getElementById('referral-base-url').value;
            const prefix = document.getElementById('referral-prefix').value;
            const codeLength = parseInt(document.getElementById('referral-code-length').value);
            
            // Generate random referral code
            const characters = 'ABCDEFGHIJKLMNOPQRSTUVWXYZ0123456789';
            let referralCode = '';
            
            for (let i = 0; i < codeLength; i++) {
                referralCode += characters.charAt(Math.floor(Math.random() * characters.length));
            }
            
            const fullReferralCode = prefix + referralCode;
            const referralLink = baseUrl.replace(/ref_$/, '') + fullReferralCode;
            
            document.getElementById('sample-referral-link').textContent = referralLink;
            
            showAlert('Sample referral link generated!', 'success');
        }

        // Find User for Referral Management
        async function findUserForReferral() {
            const searchTerm = document.getElementById('user-referral-search').value.trim();
            
            if (!searchTerm) {
                showAlert('Please enter user ID or email', 'error');
                return;
            }
            
            try {
                let userQuery;
                
                // Check if it's an email
                if (searchTerm.includes('@')) {
                    userQuery = query(collection(db, "users"), where("email", "==", searchTerm));
                } else {
                    // Assume it's a user ID
                    const userRef = doc(db, "users", searchTerm);
                    const userSnap = await getDoc(userRef);
                    
                    if (userSnap.exists()) {
                        displayUserReferralInfo(searchTerm, userSnap.data());
                        return;
                    } else {
                        showAlert('User not found', 'error');
                        return;
                    }
                }
                
                const querySnapshot = await getDocs(userQuery);
                
                if (querySnapshot.empty) {
                    showAlert('User not found', 'error');
                    return;
                }
                
                querySnapshot.forEach((docSnap) => {
                    displayUserReferralInfo(docSnap.id, docSnap.data());
                });
                
            } catch (error) {
                console.error('Error finding user:', error);
                showAlert('Error finding user', 'error');
            }
        }

        // Display User Referral Information
        function displayUserReferralInfo(userId, userData) {
            const userInfoDiv = document.getElementById('referral-user-info');
            const currentCodeDiv = document.getElementById('current-referral-code');
            const newCodeInput = document.getElementById('new-referral-code');
            const detailsDiv = document.getElementById('user-referral-details');
            
            // Store user ID in a data attribute
            detailsDiv.dataset.userId = userId;
            
            // Display user info
            userInfoDiv.innerHTML = `
                <div><strong>Name:</strong> ${userData.name || 'N/A'}</div>
                <div><strong>Email:</strong> ${userData.email || 'N/A'}</div>
                <div><strong>Referrals:</strong> ${userData.referrals || 0}</div>
                <div><strong>Join Date:</strong> ${userData.createdAt ? new Date(userData.createdAt.seconds * 1000).toLocaleDateString() : 'N/A'}</div>
            `;
            
            // Display current referral code
            const currentCode = userData.referralCode || 'No code assigned';
            currentCodeDiv.textContent = currentCode;
            
            // Set current code as placeholder for new code
            newCodeInput.placeholder = currentCode;
            newCodeInput.value = '';
            
            // Show details section
            detailsDiv.style.display = 'block';
            
            showAlert('User found successfully!', 'success');
        }

        // Update User Referral Code
        async function updateUserReferralCode() {
            const detailsDiv = document.getElementById('user-referral-details');
            const userId = detailsDiv.dataset.userId;
            const newCode = document.getElementById('new-referral-code').value.trim();
            
            if (!userId) {
                showAlert('No user selected', 'error');
                return;
            }
            
            if (!newCode) {
                showAlert('Please enter a new referral code', 'error');
                return;
            }
            
            try {
                const userRef = doc(db, "users", userId);
                
                await updateDoc(userRef, {
                    referralCode: newCode,
                    updatedAt: serverTimestamp()
                });
                
                // Update display
                document.getElementById('current-referral-code').textContent = newCode;
                document.getElementById('new-referral-code').value = '';
                
                // Log the action
                await logAdminAction(`Updated referral code for user ${userId} to ${newCode}`);
                
                showAlert('Referral code updated successfully!', 'success');
                
            } catch (error) {
                console.error('Error updating referral code:', error);
                showAlert('Error updating referral code', 'error');
            }
        }

        // Load Referral Performance Stats
        async function loadReferralPerformance() {
            try {
                const statsDiv = document.getElementById('referral-performance-stats');
                
                // Get all users with referrals
                const usersQuery = query(collection(db, "users"), where("referrals", ">", 0));
                const usersSnap = await getDocs(usersQuery);
                
                let totalReferrals = 0;
                let topReferrers = [];
                
                if (!usersSnap.empty) {
                    usersSnap.forEach((doc) => {
                        const user = doc.data();
                        const referrals = user.referrals || 0;
                        totalReferrals += referrals;
                        
                        topReferrers.push({
                            id: doc.id,
                            name: user.name || 'Anonymous',
                            referrals: referrals,
                            code: user.referralCode || 'N/A'
                        });
                    });
                }
                
                // Sort by referrals
                topReferrers.sort((a, b) => b.referrals - a.referrals);
                
                // Display stats
                let html = `
                    <div style="margin-bottom: 10px;">
                        <strong>Total Referrals:</strong> ${totalReferrals}
                    </div>
                    <div style="margin-bottom: 15px;">
                        <strong>Top 5 Referrers:</strong>
                `;
                
                if (topReferrers.length > 0) {
                    topReferrers.slice(0, 5).forEach((referrer, index) => {
                        html += `
                            <div style="display: flex; justify-content: space-between; margin-top: 5px; padding: 5px; background: rgba(255,255,255,0.05); border-radius: 4px;">
                                <div>
                                    ${index + 1}. ${referrer.name}
                                    <small style="color: #94A3B8; display: block;">Code: ${referrer.code}</small>
                                </div>
                                <div style="color: var(--primary-yellow); font-weight: bold;">
                                    ${referrer.referrals}
                                </div>
                            </div>
                        `;
                    });
                } else {
                    html += '<div style="color: #94A3B8; margin-top: 5px;">No referral data available</div>';
                }
                
                html += '</div>';
                statsDiv.innerHTML = html;
                
            } catch (error) {
                console.error('Error loading referral performance:', error);
                document.getElementById('referral-performance-stats').innerHTML = 
                    '<p style="color: var(--red);">Error loading stats</p>';
            }
        }

        // Generate Bulk Referral Links
        async function generateBulkReferralLinks() {
            const count = parseInt(document.getElementById('bulk-link-count').value);
            const prefix = document.getElementById('bulk-link-prefix').value;
            const baseUrl = document.getElementById('referral-base-url').value;
            
            if (!count || count < 1 || count > 100) {
                showAlert('Please enter a valid number between 1 and 100', 'error');
                return;
            }
            
            const characters = 'ABCDEFGHIJKLMNOPQRSTUVWXYZ0123456789';
            let linksHtml = '';
            const linksArray = [];
            
            for (let i = 0; i < count; i++) {
                let code = '';
                for (let j = 0; j < 8; j++) {
                    code += characters.charAt(Math.floor(Math.random() * characters.length));
                }
                
                const fullCode = prefix + code;
                const link = baseUrl.replace(/ref_$/, '') + fullCode;
                
                linksArray.push(link);
                linksHtml += `<div style="margin-bottom: 5px; font-size: 12px;">${link}</div>`;
            }
            
            // Store links array globally for copying
            window.bulkLinksArray = linksArray;
            
            // Display links
            document.getElementById('bulk-links-display').innerHTML = linksHtml;
            document.getElementById('bulk-links-result').style.display = 'block';
            
            showAlert(`Generated ${count} referral links!`, 'success');
        }

        // Copy All Bulk Links
        function copyAllBulkLinks() {
            if (!window.bulkLinksArray || window.bulkLinksArray.length === 0) {
                showAlert('No links to copy', 'error');
                return;
            }
            
            const linksText = window.bulkLinksArray.join('\n');
            
            navigator.clipboard.writeText(linksText).then(() => {
                showAlert('All links copied to clipboard!', 'success');
            }).catch(err => {
                console.error('Failed to copy links:', err);
                showAlert('Failed to copy links', 'error');
            });
        }

        // Copy to Clipboard Function
        function copyToClipboard(elementId) {
            const element = document.getElementById(elementId);
            const text = element.textContent || element.innerText;
            
            navigator.clipboard.writeText(text).then(() => {
                showAlert('Copied to clipboard!', 'success');
            }).catch(err => {
                console.error('Failed to copy:', err);
                showAlert('Failed to copy', 'error');
            });
        }

        // Reset Referral Search
        function resetReferralSearch() {
            document.getElementById('user-referral-search').value = '';
            document.getElementById('user-referral-details').style.display = 'none';
            document.getElementById('user-referral-details').dataset.userId = '';
        }

        // Update current date
        function updateCurrentDate() {
            const now = new Date();
            const options = { 
                weekday: 'long', 
                year: 'numeric', 
                month: 'long', 
                day: 'numeric' 
            };
            document.getElementById('current-date').textContent = now.toLocaleDateString('en-US', options);
        }

        // Setup menu handlers
        function setupMenuHandlers() {
            document.querySelectorAll('.menu-item').forEach(item => {
                item.addEventListener('click', function() {
                    const section = this.getAttribute('data-section');
                    
                    document.querySelectorAll('.menu-item').forEach(i => i.classList.remove('active'));
                    this.classList.add('active');
                    
                    showSection(section);
                });
            });
        }

        // Setup event listeners
        function setupEventListeners() {
            // Login form
            document.getElementById('login-form').addEventListener('submit', function(e) {
                e.preventDefault();
                handleAdminLogin();
            });
            
            // Logout button
            document.getElementById('admin-logout-btn').addEventListener('click', async () => {
                const confirmed = await showConfirm('Are you sure you want to logout?');
                if (confirmed) {
                    await signOut(auth);
                    showLoginPage();
                }
            });
            
            // Telegram bot config change listeners
            document.getElementById('telegram-bot-username').addEventListener('input', updateTelegramBotLinkPreview);
            document.getElementById('telegram-start-command').addEventListener('input', updateTelegramBotLinkPreview);
            document.getElementById('referral-base-url').addEventListener('input', updateTelegramBotLinkPreview);
        }

        // Setup login form
        function setupLoginForm() {
            // Already handled in setupEventListeners
        }

        // Admin login function
        async function handleAdminLogin() {
            const email = document.getElementById('admin-email').value;
            const password = document.getElementById('admin-password').value;
            const loginBtn = document.getElementById('login-btn');
            const errorDiv = document.getElementById('login-error');
            
            if (!email || !password) {
                errorDiv.textContent = 'Please enter email and password';
                errorDiv.style.display = 'block';
                return;
            }
            
            try {
                loginBtn.disabled = true;
                loginBtn.innerHTML = '<span class="loading-spinner"></span> Logging in...';
                
                const userCredential = await signInWithEmailAndPassword(auth, email, password);
                
                if (!ADMIN_UIDS.includes(userCredential.user.uid)) {
                    await signOut(auth);
                    showAlert("You are not authorized to access this panel.", "error");
                    loginBtn.disabled = false;
                    loginBtn.textContent = 'Login to Dashboard';
                    return;
                }
                
                showAlert("Login successful!", "success");
                
            } catch (error) {
                showAlert(error.message, "error");
                errorDiv.textContent = error.message;
                errorDiv.style.display = 'block';
                loginBtn.disabled = false;
                loginBtn.textContent = 'Login to Dashboard';
            }
        }

        // Show admin dashboard
        function showAdminDashboard() {
            document.getElementById('login-page').style.display = 'none';
            document.getElementById('admin-dashboard').style.display = 'flex';
            if (currentAdmin) {
                document.getElementById('admin-email-display').textContent = currentAdmin.email;
            }
        }

        // Show login page
        function showLoginPage() {
            document.getElementById('admin-dashboard').style.display = 'none';
            document.getElementById('login-page').style.display = 'flex';
            currentAdmin = null;
        }

        // ... Rest of your existing functions remain the same ...
        // Note: You should keep all your existing functions like loadDashboardData, 
        // loadUsers, handleWithdrawal, etc. They remain unchanged.

        // Utility functions
        function openModal(modalId) {
            document.getElementById(modalId).style.display = 'flex';
        }

        function closeModal(modalId) {
            document.getElementById(modalId).style.display = 'none';
        }

        // Show alert function
        function showAlert(message, type = 'info') {
            const alertContainer = document.getElementById('alert-container');
            const alertId = 'alert-' + Date.now();
            
            const alertDiv = document.createElement('div');
            alertDiv.className = `alert ${type}`;
            alertDiv.id = alertId;
            
            alertDiv.innerHTML = `
                <div class="alert-content">
                    <div class="alert-message">${message}</div>
                    <button class="alert-close" onclick="document.getElementById('${alertId}').remove()">&times;</button>
                </div>
            `;
            
            alertContainer.appendChild(alertDiv);
            
            // Auto remove after 5 seconds
            setTimeout(() => {
                if (document.getElementById(alertId)) {
                    document.getElementById(alertId).remove();
                }
            }, 5000);
        }

        // Show confirm dialog
        function showConfirm(message) {
            return new Promise((resolve) => {
                const confirmModal = document.getElementById('confirm-modal');
                const confirmMessage = document.getElementById('confirm-message');
                const confirmOk = document.getElementById('confirm-ok');
                const confirmCancel = document.getElementById('confirm-cancel');
                
                confirmMessage.textContent = message;
                confirmModal.style.display = 'flex';
                
                const okHandler = () => {
                    confirmModal.style.display = 'none';
                    resolve(true);
                    confirmOk.removeEventListener('click', okHandler);
                    confirmCancel.removeEventListener('click', cancelHandler);
                };
                
                const cancelHandler = () => {
                    confirmModal.style.display = 'none';
                    resolve(false);
                    confirmOk.removeEventListener('click', okHandler);
                    confirmCancel.removeEventListener('click', cancelHandler);
                };
                
                confirmOk.addEventListener('click', okHandler);
                confirmCancel.addEventListener('click', cancelHandler);
            });
        }

        // Make functions available globally
        window.showSection = showSection;
        window.refreshAllData = refreshAllData;
        window.searchUsers = searchUsers;
        window.clearUserSearch = clearUserSearch;
        window.prevPage = prevPage;
        window.nextPage = nextPage;
        window.viewUserDetails = viewUserDetails;
        window.editUser = editUser;
        window.saveUserEdits = saveUserEdits;
        window.toggleBlockUser = toggleBlockUser;
        window.handleWithdrawal = handleWithdrawal;
        window.filterLogs = filterLogs;
        window.searchLogs = searchLogs;
        window.sendNotificationToAllUsers = sendNotificationToAllUsers;
        window.saveBotLinks = saveBotLinks;
        window.openModal = openModal;
        window.closeModal = closeModal;
        window.showAlert = showAlert;
        window.showConfirm = showConfirm;
        
        // New functions for Token Management
        window.copyToClipboard = copyToClipboard;
        window.generateReferralLink = generateReferralLink;
        window.findUserForReferral = findUserForReferral;
        window.resetReferralSearch = resetReferralSearch;
        window.updateUserReferralCode = updateUserReferralCode;
        window.loadReferralPerformance = loadReferralPerformance;
        window.generateBulkReferralLinks = generateBulkReferralLinks;
        window.copyAllBulkLinks = copyAllBulkLinks;
        window.saveTelegramBotConfig = saveTelegramBotConfig;
        
    </script>
</body>
</html>
